defmodule Elektrine.Repo.Migrations.RemoveAiPentestFeature do
  use Ecto.Migration

  # Drop legacy tables/columns left behind by the removed AI pentest feature.
  # This is intentionally defensive (IF EXISTS + CASCADE) to support mixed DB states.
  @tables [
    # Chat/session tables
    "maid_messages",
    "maid_sessions",
    "maid_daily_usage",
    "meido_messages",
    "meido_sessions",
    "meido_daily_usage",
    # Usage/cost tracking
    "maid_llm_usage",
    # Code scanning tables
    "maid_code_vulnerabilities",
    "maid_code_scans",
    "maid_code_rules",
    "maid_secrets",
    "maid_repositories",
    # Scan/project tables (multiple historical schemas)
    "maid_tool_executions",
    "maid_agent_actions",
    "maid_finding_comments",
    "maid_findings",
    "maid_scans",
    "maid_projects",
    "maid_vulnerabilities",
    "maid_targets",
    "maid_agents",
    # Misc legacy tables
    "maid_api_keys",
    "maid_chat_messages"
  ]

  def up do
    execute("""
    DO $$
    BEGIN
      IF to_regclass('public.siem_sources') IS NOT NULL THEN
        ALTER TABLE siem_sources DROP COLUMN IF EXISTS agent_id;
      END IF;
    END $$;
    """)

    execute("""
    DO $$
    BEGIN
      IF to_regclass('public.users') IS NOT NULL THEN
        ALTER TABLE users DROP COLUMN IF EXISTS maid_tokens_used;
        ALTER TABLE users DROP COLUMN IF EXISTS maid_cost_cents;
        ALTER TABLE users DROP COLUMN IF EXISTS maid_usage_limit_cents;
      END IF;
    END $$;
    """)

    for table <- @tables do
      execute("DROP TABLE IF EXISTS #{table} CASCADE")
    end
  end

  def down do
    :ok
  end
end
