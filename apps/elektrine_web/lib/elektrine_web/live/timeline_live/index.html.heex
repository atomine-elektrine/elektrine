<div
  class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 pb-2"
  phx-hook="TimelineReply"
  id="timeline-container"
>
  <!-- Z Platform Navigation -->
  <.z_nav active_tab="timeline" />
  
<!-- Trending Hashtags Marquee -->
  <%= if @trending_hashtags && length(@trending_hashtags) > 0 do %>
    <div
      id="trending-hashtags-marquee"
      phx-update="ignore"
      class="overflow-hidden bg-base-50 rounded-lg p-2 mb-3"
    >
      <div class="flex items-center gap-2">
        <.icon name="hero-fire" class="w-4 h-4 text-orange-500 flex-shrink-0" />
        <span class="text-xs font-semibold opacity-70 flex-shrink-0">POPULAR:</span>
        <div class="overflow-hidden flex-1">
          <div class="marquee-container group">
            <%= for _i <- 1..4 do %>
              <div class="marquee-content" aria-hidden="true">
                <%= for hashtag <- @trending_hashtags do %>
                  <.link
                    href={~p"/hashtag/#{hashtag.normalized_name}"}
                    class="inline-flex items-center px-3 py-1 bg-base-200 border border-base-300 rounded-full hover:border-error hover:bg-error/5 transition-colors flex-shrink-0 text-xs font-medium whitespace-nowrap"
                    tabindex="-1"
                  >
                    #{hashtag.name} <span class="opacity-60">({hashtag.use_count})</span>
                  </.link>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
  
<!-- Mobile Action Bar -->
  <div class="sm:hidden mb-4 space-y-3">
    <!-- Top row: New Post + Filter dropdown -->
    <div class="flex gap-2">
      <%= if @current_user do %>
        <button
          phx-click="toggle_post_composer"
          class="btn btn-secondary flex-1 min-h-[2.75rem]"
          aria-label={gettext("Create new post")}
        >
          <.icon name="hero-pencil-square" class="w-5 h-5 mr-2" />
          {gettext("New Post")}
        </button>
      <% end %>
      <button
        phx-click="toggle_mobile_filters"
        class="btn btn-ghost min-h-[2.75rem] min-w-[2.75rem] px-3"
        aria-label="Toggle filters"
        aria-expanded={@show_mobile_filters}
      >
        <.icon name="hero-funnel" class="w-5 h-5" />
        <.icon
          name={if @show_mobile_filters, do: "hero-chevron-up", else: "hero-chevron-down"}
          class="w-4 h-4 ml-1"
        />
      </button>
    </div>
    
<!-- Collapsible filter panel -->
    <%= if @show_mobile_filters do %>
      <div class="bg-base-200/50 rounded-xl p-3 space-y-3 animate-in slide-in-from-top-2 duration-200">
        <!-- Primary filters -->
        <div class="grid grid-cols-3 gap-2">
          <%= if @current_user do %>
            <button
              phx-click="set_filter"
              phx-value-filter="all"
              class={[
                "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
                if(@current_filter == "all",
                  do: "bg-secondary text-secondary-content shadow-lg",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-label="Show all posts"
              aria-pressed={@current_filter == "all"}
            >
              <.icon name="hero-squares-2x2" class="w-5 h-5 mb-1" />
              <span>All</span>
            </button>
            <button
              phx-click="set_filter"
              phx-value-filter="following"
              class={[
                "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
                if(@current_filter == "following",
                  do: "bg-secondary text-secondary-content shadow-lg",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-label="Show posts from people you follow"
              aria-pressed={@current_filter == "following"}
            >
              <.icon name="hero-user-group" class="w-5 h-5 mb-1" />
              <span>Following</span>
            </button>
          <% end %>
          <button
            phx-click="set_filter"
            phx-value-filter="local"
            class={[
              "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
              if(@current_filter == "local",
                do: "bg-secondary text-secondary-content shadow-lg",
                else: "bg-base-100 text-base-content/70 hover:bg-base-200"
              )
            ]}
            aria-label="Show local posts only"
            aria-pressed={@current_filter == "local"}
          >
            <.icon name="hero-home" class="w-5 h-5 mb-1" />
            <span>Local</span>
          </button>
          <button
            phx-click="set_filter"
            phx-value-filter="federated"
            class={[
              "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
              if(@current_filter == "federated",
                do: "bg-secondary text-secondary-content shadow-lg",
                else: "bg-base-100 text-base-content/70 hover:bg-base-200"
              )
            ]}
            aria-label="Show federated posts"
            aria-pressed={@current_filter == "federated"}
          >
            <.icon name="hero-globe-americas" class="w-5 h-5 mb-1" />
            <span>Fediverse</span>
          </button>
          <%= if @current_user do %>
            <button
              phx-click="set_filter"
              phx-value-filter="saved"
              class={[
                "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
                if(@current_filter == "saved",
                  do: "bg-secondary text-secondary-content shadow-lg",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-label="Show saved posts"
              aria-pressed={@current_filter == "saved"}
            >
              <.icon name="hero-bookmark" class="w-5 h-5 mb-1" />
              <span>Saved</span>
            </button>
            <button
              phx-click="set_filter"
              phx-value-filter="rss"
              class={[
                "filter-pill flex flex-col items-center justify-center py-3 px-2 rounded-xl text-sm font-medium transition-all",
                if(@current_filter == "rss",
                  do: "bg-secondary text-secondary-content shadow-lg",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-label="Show RSS feed items"
              aria-pressed={@current_filter == "rss"}
            >
              <.icon name="hero-rss" class="w-5 h-5 mb-1" />
              <span>RSS</span>
            </button>
          <% end %>
        </div>
        
<!-- View mode filters are rendered in the feed chips below -->
        <div class="hidden pt-2 border-t border-base-300">
          <div class="text-xs font-medium opacity-60 mb-2">View mode</div>
          <div class="flex flex-wrap gap-2">
            <button
              phx-click="filter_timeline"
              phx-value-filter="all"
              class={[
                "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                if(@timeline_filter == "all",
                  do: "bg-secondary text-secondary-content",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-pressed={@timeline_filter == "all"}
            >
              All
            </button>
            <button
              phx-click="filter_timeline"
              phx-value-filter="posts"
              class={[
                "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                if(@timeline_filter == "posts",
                  do: "bg-secondary text-secondary-content",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-pressed={@timeline_filter == "posts"}
            >
              Posts
            </button>
            <button
              phx-click="filter_timeline"
              phx-value-filter="replies"
              class={[
                "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                if(@timeline_filter == "replies",
                  do: "bg-secondary text-secondary-content",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-pressed={@timeline_filter == "replies"}
            >
              Replies
            </button>
            <button
              phx-click="filter_timeline"
              phx-value-filter="media"
              class={[
                "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                if(@timeline_filter == "media",
                  do: "bg-secondary text-secondary-content",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-pressed={@timeline_filter == "media"}
            >
              Media
            </button>
            <button
              phx-click="filter_timeline"
              phx-value-filter="communities"
              class={[
                "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                if(@timeline_filter == "communities",
                  do: "bg-secondary text-secondary-content",
                  else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                )
              ]}
              aria-pressed={@timeline_filter == "communities"}
            >
              Communities
            </button>

            <%= if @current_filter != "federated" && @current_user do %>
              <%= if length(@friends) > 0 do %>
                <button
                  phx-click="filter_timeline"
                  phx-value-filter="friends"
                  class={[
                    "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                    if(@timeline_filter == "friends",
                      do: "bg-secondary text-secondary-content",
                      else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                    )
                  ]}
                  aria-pressed={@timeline_filter == "friends"}
                >
                  Friends
                </button>
              <% end %>
              <button
                phx-click="filter_timeline"
                phx-value-filter="my_posts"
                class={[
                  "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                  if(@timeline_filter == "my_posts",
                    do: "bg-secondary text-secondary-content",
                    else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                  )
                ]}
                aria-pressed={@timeline_filter == "my_posts"}
              >
                My Posts
              </button>
              <button
                phx-click="filter_timeline"
                phx-value-filter="trusted"
                class={[
                  "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                  if(@timeline_filter == "trusted",
                    do: "bg-secondary text-secondary-content",
                    else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                  )
                ]}
                aria-pressed={@timeline_filter == "trusted"}
              >
                Trusted
              </button>
            <% end %>
          </div>
        </div>
        
<!-- Platform filter -->
        <%= if @current_filter == "federated" do %>
          <div class="pt-2 border-t border-base-300">
            <div class="text-xs font-medium opacity-60 mb-2">Platform</div>
            <div class="flex flex-wrap gap-2">
              <%= for {value, label} <- [{"all", "All"}, {"mastodon", "Mastodon"}, {"pixelfed", "Pixelfed"}, {"lemmy", "Lemmy"}, {"misskey", "Misskey"}] do %>
                <button
                  phx-click="set_software_filter"
                  phx-value-software={value}
                  class={[
                    "px-3 py-1.5 rounded-full text-xs font-medium transition-all min-h-[2rem]",
                    if(@software_filter == value,
                      do: "bg-primary text-primary-content",
                      else: "bg-base-100 text-base-content/70 hover:bg-base-200"
                    )
                  ]}
                  aria-pressed={@software_filter == value}
                >
                  {label}
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
    
<!-- Search bar (always visible on mobile) -->
    <div class="relative">
      <.icon
        name="hero-magnifying-glass"
        class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-base-content/40"
      />
      <input
        type="text"
        placeholder={gettext("Search posts...")}
        value={@search_query}
        phx-change="search_timeline"
        phx-debounce="300"
        name="query"
        class="input input-bordered w-full pl-10 pr-10 min-h-[2.75rem]"
        aria-label={gettext("Search posts")}
      />
      <%= if @search_query != "" do %>
        <button
          phx-click="clear_search"
          class="absolute right-2 top-1/2 -translate-y-1/2 btn btn-ghost btn-circle btn-sm"
          aria-label={gettext("Clear search")}
        >
          <.icon name="hero-x-mark" class="w-4 h-4" />
        </button>
      <% end %>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-0 sm:gap-4 lg:gap-6">
    <!-- Left Sidebar - Post composer and search (Hidden on mobile) -->
    <div class="hidden sm:block w-48 lg:w-56 xl:w-64 flex-shrink-0 sticky top-36 self-start max-h-[calc(100vh-11rem)] z-20">
      <div
        id="timeline-left-sidebar"
        phx-hook="GlassCard"
        class="card glass-card shadow-lg flex flex-col overflow-y-auto h-full"
      >
        <div class="p-4">
          <!-- Post Composer Toggle -->
          <%= if @current_user do %>
            <div class="flex gap-2 mb-4">
              <button
                phx-click="toggle_post_composer"
                class="btn btn-secondary flex-1"
                aria-label={gettext("Create new post")}
              >
                <.icon name="hero-pencil-square" class="w-5 h-5 mr-2" />
                {gettext("New Post")}
              </button>
              <button
                phx-click="show_drafts"
                class={[
                  "btn btn-outline",
                  length(@user_drafts || []) > 0 && "indicator"
                ]}
                title={gettext("View drafts")}
              >
                <%= if length(@user_drafts || []) > 0 do %>
                  <span class="indicator-item badge badge-secondary badge-xs">
                    {length(@user_drafts)}
                  </span>
                <% end %>
                <%= if @draft_saving do %>
                  <span class="loading loading-spinner loading-xs"></span>
                <% else %>
                  <.icon name="hero-document-duplicate" class="w-5 h-5" />
                <% end %>
              </button>
            </div>
          <% end %>
          
<!-- Search -->
          <div class="relative">
            <.icon
              name="hero-magnifying-glass"
              class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-base-content/40"
            />
            <input
              type="text"
              placeholder={gettext("Search posts...")}
              value={@search_query}
              phx-change="search_timeline"
              phx-debounce="300"
              name="query"
              class="input input-bordered input-sm w-full pl-9 pr-8"
              aria-label={gettext("Search posts")}
            />
            <%= if @search_query != "" do %>
              <button
                phx-click="clear_search"
                class="absolute right-1 top-1/2 -translate-y-1/2 btn btn-ghost btn-circle btn-xs"
                aria-label={gettext("Clear search")}
              >
                <.icon name="hero-x-mark" class="w-3 h-3" />
              </button>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
<!-- Main Timeline -->
    <div
      class="flex-1 min-w-0 max-w-full sm:max-w-full card glass-card shadow-lg"
      phx-hook="InfiniteScroll"
      id="timeline-infinite-scroll"
      data-glass-card="true"
      data-offset="500"
    >
      <!-- Unified Timeline Header with Filters -->
      <div class="p-4 border-b border-base-300 bg-base-50 space-y-3">
        <div class="flex items-center justify-between gap-2">
          <h2 class="text-base font-semibold">Timeline</h2>
          <.link navigate={~p"/communities"} class="btn btn-ghost btn-xs">
            Communities
          </.link>
        </div>
        <p class="text-xs font-semibold uppercase tracking-wide text-base-content/60">Source</p>
        
<!-- Filter Pills Row -->
        <div
          class="hidden sm:flex items-center gap-2 flex-wrap"
          role="tablist"
          aria-label="Timeline filters"
        >
          <%= if @current_user do %>
            <button
              phx-click="set_filter"
              phx-value-filter="all"
              role="tab"
              aria-selected={@current_filter == "all"}
              aria-label="Show all posts"
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@current_filter == "all",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-squares-2x2" class="w-4 h-4" />
              <span>All</span>
            </button>
            <button
              phx-click="set_filter"
              phx-value-filter="following"
              role="tab"
              aria-selected={@current_filter == "following"}
              aria-label="Show posts from people you follow"
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@current_filter == "following",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-user-group" class="w-4 h-4" />
              <span>Following</span>
            </button>
          <% end %>
          <button
            phx-click="set_filter"
            phx-value-filter="local"
            role="tab"
            aria-selected={@current_filter == "local"}
            aria-label="Show local posts"
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@current_filter == "local",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-home" class="w-4 h-4" />
            <span>Local</span>
          </button>
          <button
            phx-click="set_filter"
            phx-value-filter="federated"
            role="tab"
            aria-selected={@current_filter == "federated"}
            aria-label="Show federated posts"
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@current_filter == "federated",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-globe-americas" class="w-4 h-4" />
            <span>Fediverse</span>
          </button>
          <%= if @current_user do %>
            <button
              phx-click="set_filter"
              phx-value-filter="saved"
              role="tab"
              aria-selected={@current_filter == "saved"}
              aria-label="Show saved posts"
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@current_filter == "saved",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-bookmark" class="w-4 h-4" />
              <span>Saved</span>
            </button>
            <button
              phx-click="set_filter"
              phx-value-filter="rss"
              role="tab"
              aria-selected={@current_filter == "rss"}
              aria-label="Show RSS feed items"
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@current_filter == "rss",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-rss" class="w-4 h-4" />
              <span>RSS</span>
            </button>
          <% end %>
          
<!-- Separator + Platform filter (only when federated) -->
          <%= if @current_filter == "federated" do %>
            <div class="h-6 w-px bg-base-300 mx-1"></div>
            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-sm gap-1 px-3" aria-haspopup="true">
                <.icon name="hero-funnel" class="w-4 h-4" />
                <span class="hidden lg:inline">
                  <%= case @software_filter do %>
                    <% "all" -> %>
                      All Platforms
                    <% "mastodon" -> %>
                      Mastodon
                    <% "pixelfed" -> %>
                      Pixelfed
                    <% "pleroma" -> %>
                      Pleroma
                    <% "misskey" -> %>
                      Misskey
                    <% "lemmy" -> %>
                      Lemmy
                    <% _ -> %>
                      All Platforms
                  <% end %>
                </span>
                <.icon name="hero-chevron-down" class="w-3 h-3" />
              </label>
              <ul
                tabindex="0"
                class="dropdown-content z-30 menu p-2 shadow-lg bg-base-100 rounded-box w-44 border border-base-300"
                role="menu"
              >
                <%= for {value, label} <- [{"all", "All Platforms"}, {"mastodon", "Mastodon"}, {"pixelfed", "Pixelfed"}, {"pleroma", "Pleroma"}, {"misskey", "Misskey"}, {"lemmy", "Lemmy"}] do %>
                  <li role="menuitem">
                    <button
                      phx-click="set_software_filter"
                      phx-value-software={value}
                      class={if @software_filter == value, do: "active", else: ""}
                      aria-current={if @software_filter == value, do: "true", else: "false"}
                    >
                      {label}
                    </button>
                  </li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
      <!-- Post Composer Modal -->
      <%= if @show_post_composer do %>
        <div class="p-4 border-b border-base-300 bg-base-50" id="post-composer-container">
          <.form
            for={%{}}
            phx-submit="create_post"
            phx-change="autosave_draft"
            class="space-y-4"
            id="post-composer-form"
          >
            <input
              type="text"
              name="title"
              placeholder={gettext("Title (optional)")}
              class="input input-bordered w-full"
              id="post-composer-title"
              value={@new_post_title || ""}
              phx-debounce="2000"
            />

            <%= if @show_cw_input do %>
              <input
                type="text"
                name="cw"
                placeholder={gettext("Content warning (e.g., 'spoilers', 'politics', etc.)")}
                class="input input-bordered input-warning w-full"
                id="post-composer-cw"
                value={@new_post_content_warning || ""}
                phx-debounce="2000"
              />
            <% end %>

            <textarea
              name="content"
              placeholder={gettext("What's on your mind?")}
              class="textarea textarea-bordered w-full resize-y overflow-y-auto leading-tight"
              style="min-height: 4rem; max-height: 20rem;"
              rows="3"
              phx-hook="AutoExpandTextarea"
              id="timeline-post-textarea"
              phx-debounce="2000"
            ><%= @new_post_content %></textarea>
            
<!-- Pending Media Preview -->
            <%= if !Enum.empty?(@pending_media_urls) do %>
              <div class="flex items-center gap-2 p-2 bg-base-50 rounded-lg">
                <.icon name="hero-photo" class="w-4 h-4 text-secondary" />
                <span class="text-sm">{length(@pending_media_urls)} file(s) attached</span>
                <button
                  type="button"
                  phx-click="clear_pending_images"
                  class="btn btn-ghost btn-xs ml-auto"
                >
                  <.icon name="hero-x-mark" class="w-3 h-3" />
                </button>
              </div>
            <% end %>

            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <select
                  name="visibility"
                  value={@new_post_visibility}
                  class="select select-bordered select-sm"
                  phx-update="ignore"
                  id="timeline-visibility-select"
                >
                  <option value="public">Public</option>
                  <option value="followers">Followers</option>
                  <option value="friends">Friends Only</option>
                  <option value="private">Private</option>
                </select>

                <button
                  type="button"
                  phx-click="open_image_upload"
                  class="btn btn-ghost btn-sm btn-circle"
                  title="Add media"
                >
                  <.icon name="hero-photo" class="w-4 h-4" />
                </button>

                <button
                  type="button"
                  phx-click="toggle_content_warning"
                  class={[
                    "btn btn-ghost btn-sm btn-circle",
                    @show_cw_input && "bg-warning/20 text-warning"
                  ]}
                  title="Add content warning"
                >
                  <.icon name="hero-exclamation-triangle" class="w-4 h-4" />
                </button>
              </div>

              <div class="flex gap-2 items-center">
                <span class={[
                  "text-xs",
                  String.length(@new_post_content || "") < 3 && "text-error",
                  String.length(@new_post_content || "") >= 3 && "text-success"
                ]}>
                  {String.length(@new_post_content || "")}/3 min
                </span>
                <button
                  type="button"
                  phx-click="toggle_post_composer"
                  class="btn btn-ghost btn-sm"
                >
                  {gettext("Cancel")}
                </button>
                <button
                  type="button"
                  phx-click="save_draft"
                  class="btn btn-outline btn-sm"
                  title={gettext("Save as draft")}
                  disabled={@draft_saving}
                >
                  <%= if @draft_saving do %>
                    <span class="loading loading-spinner loading-xs"></span>
                    <span class="hidden sm:inline ml-1">{gettext("Saving...")}</span>
                  <% else %>
                    <.icon name="hero-bookmark" class="w-4 h-4" />
                    <span class="hidden sm:inline ml-1">{gettext("Save Draft")}</span>
                  <% end %>
                </button>
                <button
                  type="submit"
                  class="btn btn-secondary btn-sm"
                  phx-disable-with="Posting..."
                  disabled={String.length(@new_post_content || "") < 3}
                >
                  <.icon name="hero-paper-airplane" class="w-4 h-4 mr-1" />
                  {gettext("Post")}
                </button>
              </div>
            </div>
          </.form>
        </div>
      <% end %>
      
<!-- Drafts Panel -->
      <%= if @show_drafts_panel do %>
        <div class="p-4 border-b border-base-300 bg-base-50" id="drafts-panel">
          <div class="flex justify-between items-center mb-3">
            <h3 class="font-semibold flex items-center gap-2">
              <.icon name="hero-document-duplicate" class="w-5 h-5" />
              {gettext("Your Drafts")}
            </h3>
            <button
              type="button"
              phx-click="hide_drafts"
              class="btn btn-ghost btn-sm btn-circle"
            >
              <.icon name="hero-x-mark" class="w-4 h-4" />
            </button>
          </div>

          <%= if Enum.empty?(@user_drafts || []) do %>
            <p class="text-sm text-base-content/60 py-4 text-center">
              {gettext("No drafts yet. Start writing and save for later!")}
            </p>
          <% else %>
            <div class="space-y-3 max-h-64 overflow-y-auto">
              <%= for draft <- @user_drafts do %>
                <div class="p-3 bg-base-100 rounded-lg border border-base-300">
                  <div class="flex justify-between items-start gap-2">
                    <div class="flex-1 min-w-0">
                      <%= if draft.title do %>
                        <p class="font-medium text-sm truncate">{draft.title}</p>
                      <% end %>
                      <p class="text-sm text-base-content/70 line-clamp-2">
                        {draft.content || gettext("(empty)")}
                      </p>
                      <p class="text-xs text-base-content/50 mt-1">
                        {Elektrine.TextHelpers.time_ago_short(draft.updated_at)}
                        <span class="mx-1">-</span>
                        {draft.visibility}
                      </p>
                    </div>
                    <div class="flex gap-1 flex-shrink-0">
                      <button
                        type="button"
                        phx-click="edit_draft"
                        phx-value-draft_id={draft.id}
                        class="btn btn-ghost btn-xs"
                        title={gettext("Edit")}
                      >
                        <.icon name="hero-pencil" class="w-3 h-3" />
                      </button>
                      <button
                        type="button"
                        phx-click="publish_draft"
                        phx-value-draft_id={draft.id}
                        class="btn btn-secondary btn-xs"
                        title={gettext("Publish")}
                      >
                        <.icon name="hero-paper-airplane" class="w-3 h-3" />
                      </button>
                      <button
                        type="button"
                        phx-click="delete_draft"
                        phx-value-draft_id={draft.id}
                        class="btn btn-ghost btn-xs text-error"
                        title={gettext("Delete")}
                        data-confirm={gettext("Delete this draft?")}
                      >
                        <.icon name="hero-trash" class="w-3 h-3" />
                      </button>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
      
<!-- Feed View Chips -->
      <div class="mx-4 mb-4 pt-4">
        <div class="flex items-center justify-between gap-2 mb-2">
          <p class="text-xs font-semibold uppercase tracking-wide text-base-content/60">
            View Mode
          </p>
          <p class="text-xs text-base-content/60">
            {length(@filtered_posts)} shown
          </p>
        </div>
        <div
          class="flex flex-wrap items-center gap-2"
          role="tablist"
          aria-label="Timeline view filters"
        >
          <button
            type="button"
            phx-click="filter_timeline"
            phx-value-filter="all"
            role="tab"
            aria-selected={@timeline_filter == "all"}
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@timeline_filter == "all",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-squares-2x2" class="w-4 h-4 mr-1" /> All
          </button>

          <button
            type="button"
            phx-click="filter_timeline"
            phx-value-filter="posts"
            role="tab"
            aria-selected={@timeline_filter == "posts"}
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@timeline_filter == "posts",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-document-text" class="w-4 h-4 mr-1" /> Posts
          </button>

          <button
            type="button"
            phx-click="filter_timeline"
            phx-value-filter="replies"
            role="tab"
            aria-selected={@timeline_filter == "replies"}
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@timeline_filter == "replies",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-chat-bubble-left-right" class="w-4 h-4 mr-1" /> Replies
          </button>

          <button
            type="button"
            phx-click="filter_timeline"
            phx-value-filter="media"
            role="tab"
            aria-selected={@timeline_filter == "media"}
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@timeline_filter == "media",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-photo" class="w-4 h-4 mr-1" /> Media
          </button>

          <button
            type="button"
            phx-click="filter_timeline"
            phx-value-filter="communities"
            role="tab"
            aria-selected={@timeline_filter == "communities"}
            class={[
              "btn btn-sm min-h-10 px-3 rounded-full",
              if(@timeline_filter == "communities",
                do: "btn-secondary",
                else: "btn-ghost bg-base-100 hover:bg-base-200"
              )
            ]}
          >
            <.icon name="hero-users" class="w-4 h-4 mr-1" /> Communities
          </button>

          <%= if @current_filter != "federated" && @current_user do %>
            <div class="h-6 w-px bg-base-300 mx-1"></div>

            <%= if length(@friends) > 0 do %>
              <button
                type="button"
                phx-click="filter_timeline"
                phx-value-filter="friends"
                role="tab"
                aria-selected={@timeline_filter == "friends"}
                class={[
                  "btn btn-sm min-h-10 px-3 rounded-full",
                  if(@timeline_filter == "friends",
                    do: "btn-secondary",
                    else: "btn-ghost bg-base-100 hover:bg-base-200"
                  )
                ]}
              >
                <.icon name="hero-user-group" class="w-4 h-4 mr-1" /> Friends
              </button>
            <% end %>

            <button
              type="button"
              phx-click="filter_timeline"
              phx-value-filter="my_posts"
              role="tab"
              aria-selected={@timeline_filter == "my_posts"}
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@timeline_filter == "my_posts",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-user-circle" class="w-4 h-4 mr-1" /> My Posts
            </button>

            <button
              type="button"
              phx-click="filter_timeline"
              phx-value-filter="trusted"
              role="tab"
              aria-selected={@timeline_filter == "trusted"}
              class={[
                "btn btn-sm min-h-10 px-3 rounded-full",
                if(@timeline_filter == "trusted",
                  do: "btn-secondary",
                  else: "btn-ghost bg-base-100 hover:bg-base-200"
                )
              ]}
            >
              <.icon name="hero-shield-check" class="w-4 h-4 mr-1" /> Trusted
            </button>
          <% end %>
        </div>
      </div>
      
<!-- New Posts Button -->
      <%= if length(@queued_posts) > 0 do %>
        <div class="mx-4 mb-2 flex justify-center">
          <button
            phx-click="load_queued_posts"
            data-load-queued-posts
            class="btn btn-secondary btn-sm sm:btn-md gap-2 shadow-sm animate-bounce-subtle"
          >
            <.icon name="hero-arrow-up" class="w-4 h-4" />
            <span>
              Show {length(@queued_posts)} new {if length(@queued_posts) == 1,
                do: "post",
                else: "posts"}
            </span>
          </button>
        </div>
      <% end %>
      
<!-- Timeline Feed -->
      <div class="p-4 space-y-4 isolate" data-timeline-container id="timeline-posts-container">
        <!-- Loading Skeleton -->
        <%= if @loading_timeline do %>
          <div class="space-y-4 animate-pulse">
            <div class="rounded-xl border border-base-300 bg-base-100 p-3 text-sm text-base-content/70">
              Loading timeline updates...
            </div>
            <%= for _i <- 1..3 do %>
              <div class="card bg-base-100 shadow-sm">
                <div class="card-body p-4">
                  <div class="flex items-start gap-3">
                    <div class="w-10 h-10 rounded-full bg-base-300"></div>
                    <div class="flex-1 space-y-2">
                      <div class="h-4 bg-base-300 rounded w-1/4"></div>
                      <div class="h-3 bg-base-300 rounded w-1/6"></div>
                    </div>
                  </div>
                  <div class="mt-3 space-y-2">
                    <div class="h-4 bg-base-300 rounded w-full"></div>
                    <div class="h-4 bg-base-300 rounded w-5/6"></div>
                    <div class="h-4 bg-base-300 rounded w-4/6"></div>
                  </div>
                  <div class="mt-4 flex gap-4">
                    <div class="h-6 bg-base-300 rounded w-16"></div>
                    <div class="h-6 bg-base-300 rounded w-16"></div>
                    <div class="h-6 bg-base-300 rounded w-16"></div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        <% else %>
          <!-- RSS Items (when RSS or Saved filter is active) -->
          <%= if @current_filter == "rss" do %>
            <%= if Enum.empty?(@rss_items) do %>
              <div class="text-center py-12 text-base-content/60">
                <.icon name="hero-rss" class="w-12 h-12 mx-auto mb-4 opacity-40" />
                <p class="font-medium">No RSS items yet</p>
                <p class="text-sm mt-1">
                  Subscribe to RSS feeds in Settings to see articles here
                </p>
                <a href="/account?tab=timeline" class="btn btn-secondary btn-sm mt-4">
                  Manage RSS Feeds
                </a>
              </div>
            <% else %>
              <%= for item <- @rss_items do %>
                <.rss_item
                  item={item}
                  current_user={@current_user}
                  timezone={@timezone}
                  is_saved={Map.get(@rss_saves, item.id, false)}
                />
              <% end %>
            <% end %>
          <% else %>
            
<!-- Saved RSS Items (when Saved filter is active) -->
            <%= if @current_filter == "saved" && !Enum.empty?(@rss_items) do %>
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-base-content/70 mb-2 flex items-center gap-2">
                  <.icon name="hero-rss" class="w-4 h-4 text-warning" /> Saved RSS Items
                </h3>
                <%= for item <- @rss_items do %>
                  <.rss_item
                    item={item}
                    current_user={@current_user}
                    timezone={@timezone}
                    is_saved={Map.get(@rss_saves, item.id, false)}
                  />
                <% end %>
              </div>
              <%= if !Enum.empty?(@filtered_posts) do %>
                <div class="divider text-xs text-base-content/50">Saved Posts</div>
              <% end %>
            <% end %>
            
<!-- Empty state for saved filter -->
            <%= if @current_filter == "saved" && Enum.empty?(@filtered_posts) && Enum.empty?(@rss_items) do %>
              <div class="text-center py-12 text-base-content/60">
                <.icon name="hero-bookmark" class="w-12 h-12 mx-auto mb-4 opacity-40" />
                <p class="font-medium">No saved items yet</p>
                <p class="text-sm mt-1">Save posts or RSS articles to see them here</p>
              </div>
            <% end %>
            
<!-- RSS Items for All/Following filters -->
            <%= if @current_filter in ["all", "following"] && !Enum.empty?(@rss_items) do %>
              <div class="mb-4">
                <h3 class="text-sm font-semibold text-base-content/70 mb-2 flex items-center gap-2">
                  <.icon name="hero-rss" class="w-4 h-4 text-warning" /> From Your RSS Feeds
                </h3>
                <%= for item <- @rss_items do %>
                  <.rss_item
                    item={item}
                    current_user={@current_user}
                    timezone={@timezone}
                    is_saved={Map.get(@rss_saves, item.id, false)}
                  />
                <% end %>
              </div>
              <%= if !Enum.empty?(@filtered_posts) do %>
                <div class="divider text-xs text-base-content/50">Posts</div>
              <% end %>
            <% end %>

            <% recent_post_ids = MapSet.new(@recently_loaded_post_ids || []) %>
            <% first_recent_post =
              Enum.find(@filtered_posts, fn post -> MapSet.member?(recent_post_ids, post.id) end) %>
            <% first_recent_post_id = if first_recent_post, do: first_recent_post.id, else: nil %>

            <%= for post <- @filtered_posts do %>
              <%= if first_recent_post_id && post.id == first_recent_post_id do %>
                <div class="divider text-xs font-semibold text-secondary/80">
                  {if @recently_loaded_count > 0,
                    do: "#{@recently_loaded_count} new posts",
                    else: "New posts"}
                </div>
              <% end %>
              <% # Check if this is a Lemmy community post (has community_actor_uri)
              is_lemmy_post =
                PostUtilities.has_community_uri?(post) %>
              <%= if is_lemmy_post do %>
                <!-- Lemmy-style compact post -->
                <.timeline_post
                  post={post}
                  layout={:lemmy}
                  current_user={@current_user}
                  timezone={@timezone}
                  time_format={@time_format}
                  user_likes={@user_likes}
                  user_downvotes={@user_downvotes}
                  user_boosts={@user_boosts}
                  user_saves={@user_saves}
                  user_follows={@user_follows}
                  pending_follows={@pending_follows}
                  user_statuses={@user_statuses}
                  lemmy_counts={@lemmy_counts}
                  post_interactions={@post_interactions}
                  reactions={Map.get(@post_reactions, post.id, [])}
                  replies={Map.get(@post_replies, post.id, [])}
                  on_image_click="open_image_modal"
                  source="timeline"
                />
              <% else %>
                <!-- Timeline-style post using consolidated component -->
                <.timeline_post
                  post={post}
                  layout={:timeline}
                  current_user={@current_user}
                  timezone={@timezone}
                  time_format={@time_format}
                  user_likes={@user_likes}
                  user_boosts={@user_boosts}
                  user_saves={@user_saves}
                  user_downvotes={@user_downvotes}
                  user_follows={@user_follows}
                  pending_follows={@pending_follows}
                  user_statuses={@user_statuses}
                  lemmy_counts={@lemmy_counts}
                  post_replies={@post_replies}
                  reactions={Map.get(@post_reactions, post.id, [])}
                  on_image_click="open_image_modal"
                  source="timeline"
                />
                
<!-- Reply Form -->
                <%= if @current_user && @reply_to_post && @reply_to_post.id == post.id do %>
                  <div
                    id={"reply-form-#{post.id}"}
                    class="mt-3 p-4 bg-base-50 rounded-lg border border-base-200"
                  >
                    <div class="flex items-start gap-3">
                      <div class="w-8 h-8 flex-shrink-0 overflow-visible">
                        <.user_avatar
                          user={@current_user}
                          size="sm"
                          user_statuses={@user_statuses}
                        />
                      </div>
                      <div class="flex-1 min-w-0">
                        <div class="text-sm opacity-70 mb-3">
                          {gettext("Replying to")}
                          <span class="font-medium text-error">
                            <%= if @reply_to_post.sender do %>
                              @{@reply_to_post.sender.handle || @reply_to_post.sender.username}@z.org
                            <% else %>
                              <%= if Ecto.assoc_loaded?(@reply_to_post.remote_actor) && @reply_to_post.remote_actor do %>
                                @{@reply_to_post.remote_actor.username}@{@reply_to_post.remote_actor.domain}
                              <% else %>
                                a remote user
                              <% end %>
                            <% end %>
                          </span>
                        </div>
                        
<!-- Recent Replies Preview -->
                        <%= if length(@reply_to_post_recent_replies) > 0 do %>
                          <div class="mb-3 border-l-2 border-cyan-500/60 pl-3 space-y-2">
                            <div class="text-xs font-semibold opacity-60 mb-2">
                              Recent Replies:
                            </div>
                            <%= for reply <- @reply_to_post_recent_replies do %>
                              <% has_sender = Map.get(reply, :sender) != nil

                              has_remote_actor =
                                case Map.get(reply, :remote_actor) do
                                  nil -> false
                                  %Ecto.Association.NotLoaded{} -> false
                                  _actor -> true
                                end

                              has_author = Map.get(reply, :author) != nil %>
                              <div class="text-sm">
                                <div class="flex items-center gap-2 mb-1">
                                  <%= if has_sender do %>
                                    <.username_with_effects
                                      user={reply.sender}
                                      display_name={false}
                                      verified_size="xs"
                                    />
                                  <% else %>
                                    <%= if has_remote_actor do %>
                                      <span class="font-medium">
                                        @{reply.remote_actor.username}@{reply.remote_actor.domain}
                                      </span>
                                    <% else %>
                                      <%= if has_author do %>
                                        <span class="font-medium">
                                          @{reply.author}@{reply.author_domain}
                                        </span>
                                      <% else %>
                                        <span class="font-medium opacity-50">Remote user</span>
                                      <% end %>
                                    <% end %>
                                  <% end %>
                                  <span class="text-xs opacity-50">
                                    
                                    <.local_time
                                      datetime={reply.inserted_at}
                                      format="relative"
                                      timezone={@timezone}
                                      time_format={@time_format}
                                    />
                                  </span>
                                </div>
                                <div class="text-xs opacity-70 line-clamp-2">
                                  {String.slice(reply.content, 0, 150)}{if String.length(
                                                                             reply.content
                                                                           ) > 150, do: "..."}
                                </div>
                              </div>
                            <% end %>
                          </div>
                        <% end %>

                        <.form for={%{}} phx-submit="create_timeline_reply" class="space-y-3">
                          <input type="hidden" name="reply_to_id" value={@reply_to_post.id} />
                          <textarea
                            id={"reply-textarea-#{@reply_to_post.id}"}
                            name="content"
                            placeholder={gettext("Post your reply...")}
                            class="textarea textarea-bordered w-full resize-y overflow-y-auto leading-tight"
                            style="min-height: 3rem; max-height: 15rem;"
                            rows="3"
                            phx-change="update_reply_content"
                            phx-hook="AutoExpandTextarea"
                            phx-update="ignore"
                            phx-mounted={JS.focus()}
                            required
                          ><%= @reply_content %></textarea>

                          <div class="flex gap-2 justify-end items-center">
                            <span class={[
                              "text-xs",
                              String.length(@reply_content || "") < 3 && "text-error",
                              String.length(@reply_content || "") >= 3 && "text-success"
                            ]}>
                              {String.length(@reply_content || "")}/3 min
                            </span>
                            <button
                              type="button"
                              phx-click="cancel_reply"
                              class="btn btn-ghost btn-sm"
                            >
                              {gettext("Cancel")}
                            </button>
                            <button
                              type="submit"
                              class="btn btn-secondary btn-sm"
                              phx-disable-with="Posting..."
                              disabled={String.length(@reply_content || "") < 3}
                            >
                              <.icon name="hero-paper-airplane" class="w-4 h-4 mr-1" />
                              {gettext("Reply")}
                            </button>
                          </div>
                        </.form>
                      </div>
                    </div>
                  </div>
                <% end %>
                
<!-- Direct Replies (Threaded) -->
                <% replies = Map.get(@post_replies, post.id, []) %>
                <%= if length(replies) > 0 do %>
                  <div class="mt-3 pl-4 border-l-2 border-purple-500/60 space-y-3">
                    <%= for reply <- replies do %>
                      <% normalized =
                        ElektrineWeb.Components.Social.ReplyItem.normalize_reply(reply)

                      reply_target_id =
                        Map.get(reply, :id) ||
                          Map.get(reply, :activitypub_id) ||
                          Map.get(reply, :ap_id) ||
                          normalized.ap_id %>
                      <.reply_item
                        reply={reply}
                        post={post}
                        current_user={@current_user}
                        user_statuses={@user_statuses}
                        user_follows={@user_follows}
                        pending_follows={@pending_follows}
                        user_likes={@user_likes}
                        timezone={@timezone}
                        time_format={@time_format}
                      />
                      
<!-- Quick Reply Form (for replying to this reply) -->
                      <%= if @current_user && @reply_to_reply_id == reply_target_id do %>
                        <div class="mt-3 p-3 bg-base-200 rounded-lg border border-base-300">
                          <div class="flex items-start gap-2">
                            <div class="w-8 h-8 flex-shrink-0">
                              <.user_avatar user={@current_user} size="xs" />
                            </div>
                            <div class="flex-1 min-w-0">
                              <div class="text-xs opacity-70 mb-2">
                                Replying to
                                <span class="font-medium text-error">
                                  @{normalized.handle}{if normalized.domain,
                                    do: "@#{normalized.domain}"}
                                </span>
                              </div>

                              <.form
                                for={%{}}
                                phx-submit="create_timeline_reply"
                                class="space-y-2"
                              >
                                <input
                                  type="hidden"
                                  name="reply_to_id"
                                  value={reply_target_id}
                                />
                                <textarea
                                  name="content"
                                  placeholder="Post your reply..."
                                  class="textarea textarea-bordered textarea-sm w-full"
                                  rows="2"
                                  phx-change="update_reply_content"
                                  phx-mounted={JS.focus()}
                                  required
                                ><%= @reply_content %></textarea>

                                <div class="flex gap-2 justify-end items-center">
                                  <span class={[
                                    "text-xs",
                                    String.length(@reply_content || "") < 3 && "text-error",
                                    String.length(@reply_content || "") >= 3 &&
                                      "text-success"
                                  ]}>
                                    {String.length(@reply_content || "")}/3
                                  </span>
                                  <button
                                    type="button"
                                    phx-click="cancel_reply"
                                    class="btn btn-ghost btn-xs"
                                  >
                                    Cancel
                                  </button>
                                  <button
                                    type="submit"
                                    class="btn btn-secondary btn-xs"
                                    phx-disable-with="Posting..."
                                    disabled={String.length(@reply_content || "") < 3}
                                  >
                                    <.icon name="hero-paper-airplane" class="w-3 h-3 mr-1" />
                                    Reply
                                  </button>
                                </div>
                              </.form>
                            </div>
                          </div>
                        </div>
                      <% end %>
                    <% end %>
                    
<!-- View All Replies Link -->
                    <%= if post.reply_count > length(replies) do %>
                      <button
                        phx-click="navigate_to_post"
                        phx-value-id={post.id}
                        class="text-sm text-primary hover:underline font-medium"
                        type="button"
                      >
                        View all {post.reply_count} replies 
                      </button>
                    <% end %>
                  </div>
                <% else %>
                  <!-- Load Remote Replies Button for federated posts with comments but no local replies -->
                  <% has_comments =
                    (post.reply_count && post.reply_count > 0) ||
                      (Map.get(@lemmy_counts, post.activitypub_id) &&
                         Map.get(@lemmy_counts, post.activitypub_id).comments > 0)

                  is_loading = MapSet.member?(@loading_remote_replies, post.id) %>
                  <%= if post.federated && post.activitypub_id && has_comments do %>
                    <div class="mt-3">
                      <button
                        phx-click="load_remote_replies"
                        phx-value-post_id={post.id}
                        phx-value-activitypub_id={post.activitypub_id}
                        class="btn btn-ghost btn-sm text-primary"
                        type="button"
                        disabled={is_loading}
                      >
                        <%= if is_loading do %>
                          <.spinner size="sm" /> Loading replies...
                        <% else %>
                          <.icon name="hero-chat-bubble-left-ellipsis" class="w-4 h-4 mr-1" />
                          Load replies
                        <% end %>
                      </button>
                    </div>
                  <% end %>
                <% end %>
              <% end %>
              <!-- Close else block for is_lemmy_post -->
            <% end %>
          <% end %>
          <!-- Close else for non-RSS filter -->

          <%= if Enum.empty?(@filtered_posts) && Enum.empty?(@rss_items) &&
                @current_filter not in ["saved", "rss"] do %>
            <div class="text-center py-12 text-base-content/70">
              <.icon name="hero-newspaper" class="w-12 h-12 mx-auto mb-3 opacity-40" />
              <h3 class="text-base font-semibold mb-2">
                <%= if @search_query != "" do %>
                  No matching posts
                <% else %>
                  No posts yet
                <% end %>
              </h3>
              <p class="text-sm mb-4">
                <%= if @search_query != "" do %>
                  Try a different keyword or clear search.
                <% else %>
                  Try another filter, or publish a post to start the conversation.
                <% end %>
              </p>
              <%= if @search_query != "" do %>
                <button phx-click="clear_search" class="btn btn-ghost btn-sm">
                  Clear Search
                </button>
              <% else %>
                <%= if @current_user do %>
                  <button phx-click="toggle_post_composer" class="btn btn-secondary btn-sm">
                    <.icon name="hero-plus" class="w-4 h-4 mr-1" /> New Post
                  </button>
                <% else %>
                  <.link href={~p"/login"} class="btn btn-secondary btn-sm">
                    Sign In to Post
                  </.link>
                <% end %>
              <% end %>
            </div>
          <% end %>
          
<!-- Load More Button -->
          <%= if length(@timeline_posts) >= 20 do %>
            <div class="py-4">
              <%= if @loading_more do %>
                <div class="flex items-center justify-center gap-2 mb-4 text-sm text-base-content/70">
                  <.spinner size="sm" />
                  <span>Loading more posts...</span>
                </div>
              <% end %>
              <div class="text-center mb-4">
                <button
                  phx-click="load_more_posts"
                  class="btn btn-ghost"
                  disabled={@loading_more}
                >
                  {if @loading_more, do: "Loading...", else: "Load More"}
                </button>
              </div>
              <%= if @loading_more do %>
                <div class="space-y-4">
                  <%= for _ <- 1..3 do %>
                    <.post_skeleton />
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        <% end %>
        <!-- End of loading_timeline check -->
      </div>
    </div>
    
<!-- Right Sidebar - Suggestions (Hidden on mobile and for unauthenticated users) -->
    <%= if @current_user do %>
      <div class="hidden lg:block w-16 sm:w-20 lg:w-64 xl:w-72 flex-shrink-0 sticky top-36 self-start max-h-[calc(100vh-11rem)]">
        <div
          id="timeline-right-sidebar"
          phx-hook="GlassCard"
          class="card glass-card shadow-lg p-2 lg:p-4 flex flex-col overflow-y-auto h-full"
        >
          
<!-- Follow Remote User/Community Section -->
          <div class="mb-6">
            <.fediverse_follow
              loading={@remote_user_loading}
              preview={@remote_user_preview}
              show_card={false}
            />
          </div>

          <h3 class="font-semibold mb-4">Suggested Follows</h3>
          <div class="space-y-3">
            <%= if @suggested_follows && length(@suggested_follows) > 0 do %>
              <%= for suggestion <- @suggested_follows do %>
                <div class="flex items-center gap-3 p-3 bg-base-50 rounded-lg hover:bg-base-200 transition-colors">
                  <.link
                    href={~p"/#{suggestion.handle || suggestion.username}"}
                    class="w-10 h-10 flex-shrink-0 overflow-visible block"
                  >
                    <.user_avatar
                      user={
                        %{
                          username: suggestion.handle || suggestion.username,
                          avatar: suggestion.avatar,
                          id: suggestion.id
                        }
                      }
                      size="sm"
                      user_statuses={@user_statuses}
                    />
                  </.link>
                  <div class="flex-1 min-w-0">
                    <.link
                      href={~p"/#{suggestion.handle || suggestion.username}"}
                      class="font-medium text-sm hover:underline block truncate"
                    >
                      {suggestion.display_name || suggestion.handle || suggestion.username}
                    </.link>
                    <p class="text-xs opacity-70 truncate">
                      @{suggestion.handle || suggestion.username}
                    </p>
                    <p class="text-xs text-error mt-1">{suggestion.reason}</p>
                  </div>
                  <button
                    phx-click="follow_suggested_user"
                    phx-value-user_id={suggestion.id}
                    class="btn btn-secondary btn-xs flex-shrink-0"
                  >
                    Follow
                  </button>
                </div>
              <% end %>
            <% else %>
              <div class="text-center text-sm opacity-70 py-8">
                <.icon name="hero-users" class="w-8 h-8 mx-auto mb-2 opacity-40" />
                <p>No suggestions available</p>
                <p class="text-xs mt-1">Follow some users to get better suggestions</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
  
<!-- Report Modal -->
  <%= if @show_report_modal && @current_user do %>
    <.live_component
      module={ElektrineWeb.Components.ReportModal}
      id="report-modal"
      reporter_id={@current_user.id}
      reportable_type={@report_type}
      reportable_id={@report_id}
      additional_metadata={@report_metadata}
    />
  <% end %>
  
<!-- Image Upload Modal -->
  <%= if @show_image_upload_modal && @current_user do %>
    <div class="modal modal-open">
      <div class="modal-box max-w-2xl">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-lg">Add Media to Post</h3>
          <button
            type="button"
            phx-click="close_image_upload"
            class="btn btn-ghost btn-sm btn-circle"
          >
            <.icon name="hero-x-mark" class="w-5 h-5" />
          </button>
        </div>

        <.form for={%{}} phx-submit="upload_timeline_images" phx-change="validate_timeline_upload">
          <!-- Media Upload Area -->
          <div class="form-control w-full mb-4">
            <label
              for={@uploads.timeline_attachments.ref}
              class="block border-2 border-dashed border-base-300 rounded-lg p-8 text-center cursor-pointer hover:border-secondary transition-colors"
            >
              <.live_file_input upload={@uploads.timeline_attachments} class="hidden" />
              <%= if Enum.empty?(@uploads.timeline_attachments.entries) do %>
                <.icon name="hero-photo" class="w-12 h-12 mx-auto opacity-30 mb-2" />
                <p class="text-sm opacity-70">Click to upload or drag and drop</p>
                <p class="text-xs opacity-50 mt-1">Images: JPG, PNG, GIF, WEBP</p>
                <p class="text-xs opacity-50">Videos: MP4, WEBM, OGV, MOV | Audio: MP3, WAV</p>
                <p class="text-xs opacity-50 mt-1">Up to 4 files, 50MB each</p>
              <% else %>
                <div class="space-y-4">
                  <%= for {entry, idx} <- Enum.with_index(@uploads.timeline_attachments.entries) do %>
                    <div class="border border-base-300 rounded-lg p-3">
                      <div class="flex gap-3">
                        <.live_img_preview
                          entry={entry}
                          class="rounded-lg w-24 h-24 object-cover flex-shrink-0"
                        />
                        <div class="flex-1 min-w-0">
                          <div class="text-sm font-medium mb-2 truncate">{entry.client_name}</div>
                          <input
                            type="text"
                            name={"alt_text_#{idx}"}
                            placeholder="Add image description (optional)"
                            class="input input-bordered input-sm w-full"
                            maxlength="1000"
                          />
                          <div class="text-xs opacity-60 mt-1">
                            Helps visually impaired users understand the image
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </label>
            <%= for entry <- @uploads.timeline_attachments.entries do %>
              <%= for err <- upload_errors(@uploads.timeline_attachments, entry) do %>
                <div class="alert alert-error mt-2">
                  <span class="text-sm">{error_to_string(err)}</span>
                </div>
              <% end %>
            <% end %>
          </div>

          <div class="modal-action">
            <button type="button" class="btn" phx-click="close_image_upload">Cancel</button>
            <button
              type="submit"
              class="btn btn-secondary"
              disabled={Enum.empty?(@uploads.timeline_attachments.entries)}
            >
              <.icon name="hero-check" class="w-4 h-4 mr-1" /> Add Media
            </button>
          </div>
        </.form>
      </div>
    </div>
  <% end %>
  
<!-- Full-size Image Modal -->
  <.image_modal
    show={@show_image_modal}
    image_url={@modal_image_url}
    images={@modal_images}
    image_index={@modal_image_index}
    post={@modal_post}
    timezone={@timezone}
    time_format={@time_format}
    user_statuses={@user_statuses || %{}}
    current_user={@current_user}
    is_liked={@modal_post && Map.get(@user_likes || %{}, @modal_post.id, false)}
    like_count={(@modal_post && @modal_post.like_count) || 0}
  />
  
<!-- Scroll to Top Button -->
  <button
    id="scroll-to-top"
    phx-hook="ScrollToTop"
    class="fixed bottom-6 right-6 z-50 btn btn-circle btn-primary shadow-lg opacity-0 pointer-events-none transition-all duration-300"
    aria-label="Scroll to top"
  >
    <.icon name="hero-chevron-up" class="w-5 h-5" />
  </button>
  
<!-- Quote Modal -->
  <%= if @show_quote_modal && @quote_target_post do %>
    <div
      class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50"
      phx-click="close_quote_modal"
    >
      <div
        class="bg-base-100 rounded-lg shadow-xl max-w-xl w-full max-h-[90vh] overflow-y-auto"
        phx-click="stop_propagation"
        phx-window-keydown="close_quote_modal"
        phx-key="Escape"
      >
        <div class="p-4 border-b border-base-300 flex items-center justify-between">
          <h3 class="text-lg font-semibold">Quote Post</h3>
          <button phx-click="close_quote_modal" class="btn btn-ghost btn-sm btn-circle">
            <.icon name="hero-x-mark" class="w-5 h-5" />
          </button>
        </div>

        <div class="p-4">
          <!-- Quote input -->
          <.form for={%{}} phx-submit="submit_quote" class="space-y-4">
            <div>
              <textarea
                name="content"
                placeholder="Add your thoughts..."
                class="textarea textarea-bordered w-full min-h-[100px] resize-y"
                phx-change="update_quote_content"
                phx-debounce="200"
              ><%= @quote_content %></textarea>
              <div class="text-xs text-right mt-1 opacity-60">
                {String.length(@quote_content)} characters
              </div>
            </div>
            
<!-- Preview of quoted post -->
            <div class="border border-base-300 rounded-lg p-3 bg-base-200/50">
              <div class="flex items-center gap-2 mb-2">
                <%= if @quote_target_post.sender do %>
                  <.user_avatar user={@quote_target_post.sender} size="xs" />
                  <span class="font-medium text-sm">
                    <.username_with_effects
                      user={@quote_target_post.sender}
                      display_name={true}
                      verified_size="xs"
                    />
                  </span>
                  <span class="text-xs opacity-60">@{@quote_target_post.sender.username}</span>
                <% else %>
                  <%= if Ecto.assoc_loaded?(@quote_target_post.remote_actor) && @quote_target_post.remote_actor do %>
                    <%= if @quote_target_post.remote_actor.avatar_url do %>
                      <img
                        src={@quote_target_post.remote_actor.avatar_url}
                        alt=""
                        class="w-6 h-6 rounded-full"
                      />
                    <% else %>
                      <div class="w-6 h-6 rounded-full bg-base-300 flex items-center justify-center">
                        <.icon name="hero-user" class="w-4 h-4" />
                      </div>
                    <% end %>
                    <span class="font-medium text-sm">
                      {@quote_target_post.remote_actor.display_name ||
                        @quote_target_post.remote_actor.username}
                    </span>
                    <span class="text-xs opacity-60">
                      @{@quote_target_post.remote_actor.username}@{@quote_target_post.remote_actor.domain}
                    </span>
                  <% end %>
                <% end %>
              </div>
              <div class="text-sm line-clamp-4 opacity-80">
                {@quote_target_post.content}
              </div>
              <%= if @quote_target_post.media_urls && length(@quote_target_post.media_urls) > 0 do %>
                <div class="mt-2 flex gap-1">
                  <%= for _url <- Enum.take(@quote_target_post.media_urls, 4) do %>
                    <div class="w-12 h-12 bg-base-300 rounded flex items-center justify-center">
                      <.icon name="hero-photo" class="w-5 h-5 opacity-50" />
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>

            <div class="flex justify-end gap-2">
              <button type="button" phx-click="close_quote_modal" class="btn btn-ghost">
                Cancel
              </button>
              <button
                type="submit"
                class="btn btn-secondary"
                disabled={String.trim(@quote_content) == ""}
              >
                <.icon name="hero-chat-bubble-bottom-center-text" class="w-4 h-4 mr-1" /> Quote
              </button>
            </div>
          </.form>
        </div>
      </div>
    </div>
  <% end %>
</div>
