# fly.toml app configuration file generated for elektrine on 2025-05-11T18:25:36-04:00
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
#

app = 'elektrine'
primary_region = 'iad'
kill_signal = 'SIGTERM'

[build]

[deploy]
  release_command = '/app/bin/elektrine eval "Elektrine.Release.migrate"'

[env]
  PHX_HOST = 'elektrine.com'
  ECTO_IPV6 = 'true'
  POOL_SIZE = '20'
  DB_QUEUE_TARGET_MS = '2000'
  DB_QUEUE_INTERVAL_MS = '5000'
  DB_TIMEOUT_MS = '30000'
  DB_POOL_TIMEOUT_MS = '30000'
  DB_CONNECT_TIMEOUT_MS = '30000'
  MIGRATION_POOL_SIZE = '2'
  MIGRATION_TIMEOUT_MS = '120000'
  MIGRATION_POOL_TIMEOUT_MS = '60000'
  MIGRATION_CONNECT_TIMEOUT_MS = '60000'
  MIGRATION_DB_RETRIES = '30'
  MIGRATION_RETRY_DELAY_MS = '3000'

# =========================================================================
# HTTP Service (port 8080 internally) - Fly handles TLS termination
# Uses non-privileged port internally since app runs as nobody user
# =========================================================================
[[services]]
  internal_port = 8080
  protocol = 'tcp'
  auto_stop_machines = 'suspend'
  auto_start_machines = true
  min_machines_running = 1

  [[services.ports]]
    port = 80
    handlers = ['http']

  [[services.ports]]
    port = 443
    handlers = ['tls', 'http']

  [[services.http_checks]]
    interval = '30s'
    timeout = '5s'
    grace_period = '30s'
    method = 'GET'
    path = '/health'

  [services.concurrency]
    type = 'connections'
    hard_limit = 500
    soft_limit = 400

[[vm]]
  memory = '4gb'
  cpu_kind = 'shared'
  cpus = 8

# Single volume for runtime data
[[mounts]]
  source = 'app_data'
  destination = '/data'

# POP3 Service (port 2110 internally, 995 externally with TLS)
[[services]]
  internal_port = 2110
  protocol = 'tcp'
  auto_stop_machines = 'suspend'
  auto_start_machines = true
  min_machines_running = 1

  [[services.ports]]
    port = 995
    handlers = ['tls', 'proxy_proto']
    proxy_proto_options = { version = 'v1' }

  [[services.tcp_checks]]
    interval = '30s'
    timeout = '5s'
    grace_period = '30s'

# IMAP Service (port 2143 internally, 993 externally with TLS)
[[services]]
  internal_port = 2143
  protocol = 'tcp'
  auto_stop_machines = 'suspend'
  auto_start_machines = true
  min_machines_running = 1

  [[services.ports]]
    port = 993
    handlers = ['tls', 'proxy_proto']
    proxy_proto_options = { version = 'v1' }

  [[services.tcp_checks]]
    interval = '30s'
    timeout = '5s'
    grace_period = '30s'

# SMTP Service (port 2587 internally, 465 externally with TLS)
[[services]]
  internal_port = 2587
  protocol = 'tcp'
  auto_stop_machines = 'suspend'
  auto_start_machines = true
  min_machines_running = 1

  [[services.ports]]
    port = 465
    handlers = ['tls', 'proxy_proto']
    proxy_proto_options = { version = 'v1' }

  [[services.tcp_checks]]
    interval = '30s'
    timeout = '5s'
    grace_period = '30s'
